#!/bin/sh

set -e

case "$1" in
    configure)
        
	a2enmod ssl || echo "Error enabling Apache ssl module."
	a2dismod autoindex || echo "Error disabling Apache autoindex module."
	a2dissite 000-default || echo "Error disabling Apache HTTP listener."
	a2ensite securityonion || echo "Error enabling Apache securityonion site."
        
	FILE="/etc/apache2/ports.conf"
	if [ ! -f $FILE ]; then
		echo "$FILE not found."
	else
		if grep "Listen 80" $FILE>/dev/null; then
			sed -i 's|^Listen 80$||g' $FILE || echo "Error updating $FILE."
		fi
	fi

	# Originally, Squert had its own authentication.
	# We've moved to SSO for the Elastic integration.
	# Two files need to be updated for Squert or SSO auth:
	LOGIN="/var/www/so/squert/login.php"
	JS="/var/www/so/squert/.js/squertMain.js"
	# Default to Squert auth.
	# If SSO is configured, copy SSO files.
	# Otherwise, copy Squert auth files.
	FROM="/var/www/so/squert/.auth/squert"
	if ! [ -f ${LOGIN} ]; then
		echo "${LOGIN} does not exist.  Configuring for Squert authentication."
	else
		if grep -q PHP_AUTH_USER ${LOGIN} ; then
			echo "${LOGIN} is configured for SSO authentication.  Updating SSO auth files."
			FROM="/var/www/so/squert/.auth/sso"
		else
			echo "${LOGIN} is configured for Squert authentication.  Updating Squert auth files."
		fi
	fi
	cp ${FROM}/login.php ${LOGIN} || echo "Error copying ${FROM}/login.php to ${LOGIN}."
	cp ${FROM}/squertMain.js ${JS} || echo "Error copying ${FROM}/squertMain.js to ${JS}."

        apache2ctl restart || echo "Error restarting Apache."
        
	if ! grep "/var/www/so/squert/.scripts/Ip2c/results.txt" /etc/apparmor.d/local/usr.sbin.mysqld >/dev/null; then
		echo "/var/www/so/squert/.scripts/Ip2c/results.txt r," >> /etc/apparmor.d/local/usr.sbin.mysqld
		service apparmor reload || echo "Error reloading apparmor."
	fi

	[ -f /etc/mysql/conf.d/securityonion-squert.conf ] && rm -f /etc/mysql/conf.d/securityonion-squert.conf
	
	echo "Please wait while updating database..."
	bash /var/www/so/squert/.scripts/securityonion_update.sh || echo "Error running SQL update.  See /var/log/nsm/squert_update.log."

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
