#!/bin/sh

set -e

case "$1" in
    configure)
        
	a2enmod ssl || echo "Error enabling Apache ssl module."
	a2dismod autoindex || echo "Error disabling Apache autoindex module."
	a2dissite 000-default || echo "Error disabling Apache HTTP listener."
	a2ensite securityonion || echo "Error enabling Apache securityonion site."
        
	FILE="/etc/apache2/ports.conf"
	if [ ! -f $FILE ]; then
		echo "$FILE not found."
	else
		if grep "Listen 80" $FILE>/dev/null; then
			sed -i 's|^Listen 80$||g' $FILE || echo "Error updating $FILE."
		fi
	fi

	# Squert has its own native authentication, but we're moving to SSO for the Elastic integration.
	# If Apache is configured for SSO, then configure Squert for SSO.
	# Otherwise, configure Squert for native authentication.
	AUTH="native"
	SO="/var/www/so/"
	SQUERT="${SO}/squert"
	CONF="/etc/apache2/sites-enabled/securityonion.conf"
	if ! [ -f ${CONF} ]; then
		echo "${CONF} does not exist.  Configuring for Squert authentication."
	else
		if grep -q "<Location /squert>" ${CONF} ; then
			echo "${CONF} is configured for SSO authentication.  Updating SSO auth files."
			AUTH="sso"
		else
			echo "${CONF} is configured for Squert authentication.  Updating Squert auth files."
		fi
	fi
	cp -av /opt/squert/auth/${AUTH}/squert ${SO} || echo "Error copying from /opt/squert/auth/${AUTH}/squert to ${SO}."

        apache2ctl restart || echo "Error restarting Apache."
        
	if ! grep "/var/www/so/squert/.scripts/Ip2c/results.txt" /etc/apparmor.d/local/usr.sbin.mysqld >/dev/null; then
		echo "/var/www/so/squert/.scripts/Ip2c/results.txt r," >> /etc/apparmor.d/local/usr.sbin.mysqld
		service apparmor reload || echo "Error reloading apparmor."
	fi

	[ -f /etc/mysql/conf.d/securityonion-squert.conf ] && rm -f /etc/mysql/conf.d/securityonion-squert.conf
	
	echo "Please wait while updating database..."
	bash /var/www/so/squert/.scripts/securityonion_update.sh || echo "Error running SQL update.  See /var/log/nsm/squert_update.log."

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.



exit 0
